version: '3.8'

services:
  # Local mode - single container with multiple threads
  spark-local:
    image: spark-stream-table:latest
    container_name: spark-local
    environment:
      # Spark configuration
      SPARK_MODE: local
      PARALLELISM: 4
      SPARK_DRIVER_MEMORY: 2g
      SPARK_DRIVER_CORES: 2
      
      # AWS configuration
      AWS_REGION: eu-central-1
      # AWS credentials (replace with your credentials)
      # AWS_ACCESS_KEY_ID: your_access_key
      # AWS_SECRET_ACCESS_KEY: your_secret_key
      # AWS_SESSION_TOKEN: your_session_token
      
      # Catalog configuration
      CATALOG_TYPE: s3tables
      # S3_TABLE_BUCKET_ARN: arn:aws:s3tables:eu-central-1:667654397356:bucket/iceberg-warehouse1
      
      # Table configuration
      TABLE_NAMESPACE: raw_data
      TABLE_NAME: test_table
      
      # Streaming configuration
      CHECKPOINT_DIR: /app/checkpoints
      TRIGGER_INTERVAL: "10 seconds"
      # KEY_FIELD: id
      
      # Kafka configuration
      KAFKA_BOOTSTRAP_SERVERS: bastion.ocp.tangram-soft.com:31700
      KAFKA_OUTPUT_TOPIC: iceberg-output-topic
      KAFKA_SECURITY_PROTOCOL: PLAINTEXT
      # KAFKA_SASL_MECHANISM: PLAIN
      # KAFKA_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.plain.PlainLoginModule required username='user' password='pass';"
    ports:
      - "4040:4040"  # Spark UI
    volumes:
      - ./checkpoints:/app/checkpoints
      - ~/.aws:/root/.aws:ro
    restart: unless-stopped
    networks:
      - spark-network

networks:
  spark-network:
    driver: bridge
